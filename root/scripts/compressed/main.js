function MiniMenu(){var b=this;this.isOpen=false;this.menu=null;this.menuElem=null;this.menuListElem=null;this.defaultTimeout=2000;this.timeout=null;this.currentAnchorId="";this.contextId=null;this.itemId=null;var a={};this.registerHandler=function(c,d){a[c]={context:c,handler:d}};this.load=function(){$("body").prepend("<div id='miniMenu'><ul></ul></div>");b.menu=$("#miniMenu");b.menuElem=b.menu[0];b.menuList=$("#miniMenu ul");b.menuListElem=b.menuList[0];b.menu.hover(b.mouseOver,b.mouseOut);$(".miniMenuAnchor").each(b.anchorAttach)};this.close=function(){$("#"+b.currentAnchorId).removeClass("stayOn");b.currentAnchorId="";clearTimeout(b.timeout);b.menu.hide();b.menuList.empty();b.isOpen=false};this.startClosing=function(){clearTimeout(b.timeout);b.timeout=setTimeout("miniMenu.onTimeout()",b.defaultTimeout)};this.stopClosing=function(){clearTimeout(b.timeout)};this.onTimeout=function(c){b.close()};this.open=function(e){if(b.isOpen){b.close()}b.currentAnchorId=e.id;b.contextId=b.currentAnchorId.substring(0,b.currentAnchorId.indexOf("-"));b.itemId=b.currentAnchorId.substring(b.currentAnchorId.indexOf("-")+1,999);var h=a[b.contextId].handler;$("#"+b.currentAnchorId).addClass("stayOn");var j=$(e).offset();b.menuElem.style.top=j.top+"px";b.menuElem.style.left=(j.left-110)+"px";b.menuList.empty();var f=h.getMenuItems();var c=function(k){return function(l){k.callback(b.contextId,k.id,b.itemId);b.close()}};for(item in f){var g=f[item];var i=$("<li><a href='javascript:return false;'>"+g.label+"</a></li>");b.menuList.append(i);var d=$("a",i).click(c(g))}b.menu.show();b.isOpen=true};this.mouseOut=function(c){b.startClosing()};this.mouseOver=function(c){b.stopClosing()};this.anchorMouseOver=function(c){$(this).addClass("on")};this.anchorMouseOut=function(c){if(b.currentAnchorId==this.id){b.startClosing()}$(this).removeClass("on")};this.anchorClick=function(d,c){b.open(c)};this.contextMouseOver=function(d,c){$(c).addClass("hover")};this.contextMouseOut=function(d,c){$(c).removeClass("hover")};this.anchorAttach=function(d,c){$(this).hover(b.anchorMouseOver,b.anchorMouseOut);$(this).click(function(f){b.anchorClick(f,c)});$(this).parents(".miniMenuContext").hover(function(f){b.contextMouseOver(f,c)},function(f){b.contextMouseOut(f,c)})}}function miniMenuHandler(b){var a={};this.context=b;this.getMenuItems=function(){var c=[];for(item in a){c.push(a[item])}return c};this.addMenuItem=function(e,c,d){a[e]={id:e,label:c,callback:d}}}var storyPostHandler=new miniMenuHandler();storyPostHandler.addMenuItem("comment","Comment",function(a,b,c){$.getJSON("/Talk/Post/"+c+"/Reply/MiniForm/JSON",function(d){if(d.errorCode==0){$("#"+c).prepend(d.html)}else{if(d.errorCode>0){alert("Oups! A problem occured: "+d.errorMessage+" (Error code:"+d.errorCode+")")}}})});storyPostHandler.addMenuItem("delete","Delete",function(a,b,c){$.getJSON("/Stories/Post/"+c+"/Delete/JSON",function(d){if(d.errorCode==0){console.debug("deleting:",c);$("#"+c).slideUp(1000)}else{if(d.errorCode>0){alert("Oups! A problem occured: "+d.errorMessage+" (Error code:"+d.errorCode+")")}}})});var storyPostReplyHandler=new miniMenuHandler();storyPostReplyHandler.addMenuItem("delete","Delete",function(a,b){console.debug("delete",a,menuItemId,b)});var topicHandler=new miniMenuHandler();topicHandler.addMenuItem("delete","Delete",function(b,a,c){$.getJSON("/Talk/Topic/"+c+"/Delete/JSON",function(d){if(d.errorCode==0){console.debug("deleting:",c,d);$("#"+c+"-topicMenu").hide();$("#"+c).hide();$("#"+c).after($("<strong>"+d.html+"</strong>"))}else{if(d.errorCode>0){alert("Oups! A problem occured: "+d.errorMessage+" (Error code:"+d.errorCode+")")}}})});var miniMenu=new MiniMenu();miniMenu.registerHandler("topic",topicHandler);miniMenu.registerHandler("storyPost",storyPostHandler);miniMenu.registerHandler("storyPostReply",storyPostReplyHandler);$(document).ready(function(){miniMenu.load()});